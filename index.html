<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Bilder's 3D Archive</title>

  <!-- A-Frame -->
  <!-- <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script> -->
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>


</head>

<body>


<a-scene>

  <!-- アセット管理 -->
  <a-assets>
    <img id="sky" src="assets/kloppenheim_06_puresky_small.jpg">
    <video id="movie" src="assets/TEST-1.mp4" loop muted playsinline></video>
    <a-asset-item id="dome" src="assets/BOD_v3_Env.glb"></a-asset-item>
    <a-asset-item id="screen" src="assets/BOD_v3_Screen.glb"></a-asset-item>
  </a-assets>

  <!-- 空（回転で向き調整） -->
  <a-sky src="#sky" rotation="0 -90 0"></a-sky>

	
  <a-gltf-model
    src="#screen"
    position="0 2 0"
    scale="2 2 2"
	material="src:#movie">
  </a-gltf-model>

  <!-- 動画スクリーン -->
  <a-plane
    position="0 2 -4"
    width="3"
    height="1.7"
    material="src: #movie">
  </a-plane>


</a-scene>
<script>
document.body.addEventListener('click', () => {
  document.getElementById('movie').play();
}, { once: true });

model.addEventListener('model-loaded', () => {
  const mesh = model.getObject3D('mesh');
  mesh.traverse(obj => {
    console.log(
      obj.name,
      obj.type,
      obj.material
    );
  });
});

AFRAME.scenes[0].addEventListener('loaded', () => {
  const model = document.querySelector('[gltf-model]');

  model.addEventListener('model-loaded', () => {
    const root = model.getObject3D('mesh');
    const video = document.getElementById('movie');

    const videoTexture = new AFRAME.THREE.VideoTexture(video);
    videoTexture.flipY = false;
    videoTexture.colorSpace = AFRAME.THREE.SRGBColorSpace;
    videoTexture.needsUpdate = true;

    root.traverse(obj => {
      if (obj.type === 'Mesh') {

        // material が配列の場合に対応
        const materials = Array.isArray(obj.material)
          ? obj.material
          : [obj.material];

        materials.forEach(mat => {
          mat.map = videoTexture;
          mat.needsUpdate = true;
        });
      }
    });
  });
});
</script>


</body>
</html>
